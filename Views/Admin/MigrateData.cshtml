@{
    ViewData["Title"] = "Data Migration";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3"><i class="bi bi-database-gear me-2"></i>Data Migration</h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>SQLite to PostgreSQL Migration</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>About this migration:</strong>
                        <p class="mb-0 mt-2">
                            This tool will copy all data from the local SQLite database (included in the deployment)
                            to the PostgreSQL database (Supabase). This is useful when migrating from development
                            to production or restoring data.
                        </p>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Existing data in PostgreSQL will NOT be deleted, but duplicates will be skipped</li>
                            <li>This process may take several minutes depending on data volume</li>
                            <li>Large binary data (documents) may take extra time</li>
                        </ul>
                    </div>

                    <div class="d-grid">
                        <button id="migrateBtn" class="btn btn-lg btn-success">
                            <i class="bi bi-play-circle me-2"></i>Start Migration
                        </button>
                    </div>

                    <div id="progressSection" class="mt-4" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span>Migration in progress... Please wait.</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="resultSection" class="mt-4" style="display: none;">
                        <h5><i class="bi bi-journal-text me-2"></i>Migration Log:</h5>
                        <pre id="migrationLog" class="bg-dark text-light p-3 rounded"
                            style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Help</h5>
                </div>
                <div class="card-body">
                    <h6>What gets migrated?</h6>
                    <ul class="small">
                        <li>Customers &amp; Suppliers</li>
                        <li>Users &amp; Roles</li>
                        <li>System Settings</li>
                        <li>Invoices &amp; Invoice Items</li>
                        <li>Payments &amp; Allocations</li>
                        <li>Purchase Orders &amp; Requisitions</li>
                        <li>Imported Documents (with file content)</li>
                        <li>Audit Logs</li>
                    </ul>

                    <h6 class="mt-3">Troubleshooting</h6>
                    <p class="small text-muted">
                        If migration fails, check that the SQLite database file is included in the deployment
                        and that the PostgreSQL connection is working properly.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('migrateBtn').addEventListener('click', async function () {
            const btn = this;
            const progressSection = document.getElementById('progressSection');
            const resultSection = document.getElementById('resultSection');
            const migrationLog = document.getElementById('migrationLog');
            const progressBar = document.getElementById('progressBar');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Migrating...';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 500);

            try {
                const response = await fetch('@Url.Action("RunMigration")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                resultSection.style.display = 'block';
                migrationLog.textContent = result.message;

                if (result.success) {
                    progressBar.classList.remove('bg-primary');
                    progressBar.classList.add('bg-success');
                    btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Migration Complete!';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-secondary');
                } else {
                    progressBar.classList.remove('bg-primary');
                    progressBar.classList.add('bg-danger');
                    btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Migration Failed';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');
                    btn.disabled = false;
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.classList.remove('bg-primary');
                progressBar.classList.add('bg-danger');

                resultSection.style.display = 'block';
                migrationLog.textContent = 'Error: ' + error.message;

                btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Migration Failed';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                btn.disabled = false;
            }
        });
    </script>
}

<form asp-action="RunMigration" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>