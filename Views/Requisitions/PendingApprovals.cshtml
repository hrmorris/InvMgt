@model IEnumerable<Requisition>

@{
    ViewData["Title"] = "Pending Approvals";
    var role = ViewBag.Role as string ?? "supervisor";
    var roleTitle = role switch
    {
        "supervisor" => "Supervisor Approval",
        "finance" => "Finance/Admin Officer Review",
        "manager" => "Manager Approval",
        _ => "Pending Approvals"
    }
@functions {
    public string FormatCurrency(decimal amount)
    {
        var settings = ViewData["CurrencySettings"] as CurrencySettings;
        if (settings != null)
        {
            return CurrencyHelper.FormatCurrency(amount, settings);
        }
        return $"K {amount:N2}";
    }
    public string CurrencySymbol()
    {
        return ViewData["CurrencySymbol"]?.ToString() ?? "K";
    }
}
;
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-clock-history"></i> @roleTitle - Pending Approvals</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a asp-action="PendingApprovals" asp-route-role="supervisor" class="btn btn-sm @(role == "supervisor" ? "btn-primary" : "btn-outline-primary")">
                <i class="bi bi-person-check"></i> Supervisor
            </a>
            <a asp-action="PendingApprovals" asp-route-role="finance" class="btn btn-sm @(role == "finance" ? "btn-primary" : "btn-outline-primary")">
                <i class="bi bi-cash-stack"></i> Finance
            </a>
            <a asp-action="PendingApprovals" asp-route-role="manager" class="btn btn-sm @(role == "manager" ? "btn-primary" : "btn-outline-primary")">
                <i class="bi bi-person-badge"></i> Manager
            </a>
        </div>
        <a asp-action="Index" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No pending approvals for @role role at this time.
    </div>
}
else
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> <strong>@Model.Count()</strong> requisition(s) pending your approval.
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Requisition #</th>
                    <th>Date</th>
                    <th>Requested By</th>
                    <th>Department</th>
                    <th>Facility Type</th>
                    <th>Purpose</th>
                    <th>Estimated Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var requisition in Model)
                {
                    <tr>
                        <td>
                            <strong>@requisition.RequisitionNumber</strong>
                        </td>
                        <td>@requisition.RequisitionDate.ToString("dd/MM/yyyy")</td>
                        <td>@requisition.RequestedBy</td>
                        <td>@requisition.Department</td>
                        <td>
                            <span class="badge @(requisition.FacilityType == "Hospital" ? "bg-primary" : "bg-info")">
                                @requisition.FacilityType
                            </span>
                        </td>
                        <td>
                            @if (requisition.Purpose?.Length > 50)
                            {
                                <span title="@requisition.Purpose">@requisition.Purpose.Substring(0, 47)...</span>
                            }
                            else
                            {
                                @requisition.Purpose
                            }
                        </td>
                        <td>
                            @if (requisition.EstimatedAmount > 0)
                            {
                                <strong>@FormatCurrency(requisition.EstimatedAmount)</strong>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @{
                                var statusClass = requisition.Status switch
                                {
                                    "Pending_Supervisor" => "bg-warning text-dark",
                                    "Pending_Finance" => "bg-info",
                                    "Pending_Approval" => "bg-primary",
                                    "Approved" => "bg-success",
                                    "Rejected" => "bg-danger",
                                    _ => "bg-secondary"
                                };
                                var statusText = requisition.Status.Replace("_", " ");
                            }
                            <span class="badge @statusClass">@statusText</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a asp-action="Details" asp-route-id="@requisition.Id" class="btn btn-sm btn-info" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                @if ((role == "supervisor" && requisition.Status == "Pending_Supervisor") ||
                                     (role == "finance" && requisition.Status == "Pending_Finance") ||
                                     (role == "manager" && requisition.Status == "Pending_Approval"))
                                {
                                    <a asp-action="Approve" asp-route-id="@requisition.Id" 
                                       class="btn btn-sm btn-success" title="Process Approval">
                                        <i class="bi bi-check-circle"></i>
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Approval Workflow</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="bi bi-1-circle-fill text-primary"></i> Supervisor Review</h6>
                    <p class="small text-muted">Supervisor checks and approves the requisition request.</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-2-circle-fill text-info"></i> Finance/Admin Review</h6>
                    <p class="small text-muted">Finance officer screens based on budget, need, and cost code.</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-3-circle-fill text-success"></i> Final Approval</h6>
                    <p class="small text-muted">Health Manager (outstation) or Hospital Executive/Finance Manager (hospital) gives final approval.</p>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Auto-refresh every 60 seconds
        setTimeout(function() {
            location.reload();
        }, 60000);
    </script>
}

