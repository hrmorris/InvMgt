@model InvoiceManagement.Models.ViewModels.AiImportInvoiceViewModel
@{
    ViewData["Title"] = "Review Imported Invoice";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-file-earmark-check text-success me-2"></i>Review Imported Invoice
            </h2>
            <p class="text-muted mb-0">
                Verify the extracted data and make any necessary corrections before saving.
            </p>
        </div>
        <div>
            <a asp-action="Invoice" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Start Over
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.OriginalFileName))
    {
        <div class="alert alert-info d-flex align-items-center mb-4">
            <i class="bi bi-file-earmark-text fs-4 me-3"></i>
            <div>
                <strong>Source Document:</strong> @Model.OriginalFileName
                @if (Model.DocumentId > 0)
                {
                    <span class="badge bg-success ms-2">Stored</span>
                }
            </div>
        </div>
    }

    <form asp-action="SaveInvoice" method="post">
        <input type="hidden" asp-for="DocumentId" />
        <input type="hidden" asp-for="OriginalFileName" />
        <input type="hidden" asp-for="MatchedSupplierId" />
        <input type="hidden" asp-for="MatchedSupplierName" />
        <input type="hidden" asp-for="MatchedCustomerId" />
        <input type="hidden" asp-for="MatchedCustomerName" />
        <input type="hidden" asp-for="ExtractedSupplierName" />
        <input type="hidden" asp-for="ExtractedCustomerName" />

        <div class="row">
            <!-- Left Column: Invoice Details -->
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Invoice Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="InvoiceNumber" class="form-label">Invoice Number <span
                                        class="text-danger">*</span></label>
                                <input asp-for="InvoiceNumber" class="form-control" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Allocate To <span class="text-danger">*</span></label>
                                <div class="btn-group w-100" role="group" aria-label="Allocation type">
                                    <input type="radio" class="btn-check" name="allocationType" id="allocateSupplier"
                                        value="Supplier" checked>
                                    <label class="btn btn-outline-primary" for="allocateSupplier">
                                        <i class="bi bi-building me-1"></i>Supplier
                                    </label>
                                    <input type="radio" class="btn-check" name="allocationType" id="allocateCustomer"
                                        value="Customer">
                                    <label class="btn btn-outline-success" for="allocateCustomer">
                                        <i class="bi bi-person me-1"></i>Customer
                                    </label>
                                </div>
                                <input type="hidden" asp-for="InvoiceType" />
                                <small class="form-text text-muted mt-1 d-block">Choose whether this invoice is from a
                                    supplier (expense) or to a customer (income)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="InvoiceDate" class="form-label">Invoice Date</label>
                                <input asp-for="InvoiceDate" type="date" class="form-control"
                                    value="@(Model.InvoiceDate?.ToString("yyyy-MM-dd"))" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="DueDate" class="form-label">Due Date</label>
                                <input asp-for="DueDate" type="date" class="form-control"
                                    value="@(Model.DueDate?.ToString("yyyy-MM-dd"))" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white" id="customerInfoHeader">
                        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Supplier/Vendor Information</h5>
                    </div>
                    <div class="card-body" id="customerInfoSection">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerName" class="form-label" id="entityNameLabel">Supplier Name</label>
                                <input asp-for="CustomerName" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerEmail" class="form-label">Email</label>
                                <input asp-for="CustomerEmail" type="email" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerPhone" class="form-label">Phone</label>
                                <input asp-for="CustomerPhone" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerAddress" class="form-label">Address</label>
                                <input asp-for="CustomerAddress" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Invoice Items</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Items != null && Model.Items.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50%">Description</th>
                                            <th class="text-end">Quantity</th>
                                            <th class="text-end">Unit Price</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Items.Count; i++)
                                        {
                                            <tr>
                                                <td>
                                                    <input asp-for="Items[i].Description"
                                                        class="form-control form-control-sm" />
                                                </td>
                                                <td>
                                                    <input asp-for="Items[i].Quantity" type="number" step="0.01"
                                                        class="form-control form-control-sm text-end item-qty" />
                                                </td>
                                                <td>
                                                    <input asp-for="Items[i].UnitPrice" type="number" step="0.01"
                                                        class="form-control form-control-sm text-end item-price" />
                                                </td>
                                                <td class="text-end align-middle item-total">
                                                    @((Model.Items[i].Quantity * Model.Items[i].UnitPrice).ToString("N2"))
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No line items were extracted from the document.</p>
                        }
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>Amounts</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="SubTotal" class="form-label">Sub Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">K</span>
                                    <input asp-for="SubTotal" type="number" step="0.01" class="form-control text-end" />
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="GSTAmount" class="form-label">GST Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">K</span>
                                    <input asp-for="GSTAmount" type="number" step="0.01"
                                        class="form-control text-end" />
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="TotalAmount" class="form-label">Total Amount <span
                                        class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">K</span>
                                    <input asp-for="TotalAmount" type="number" step="0.01"
                                        class="form-control text-end fw-bold" required />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-sticky me-2"></i>Notes</h5>
                    </div>
                    <div class="card-body">
                        <textarea asp-for="Notes" class="form-control" rows="3"
                            placeholder="Any additional notes about this invoice..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column: Entity Matching -->
            <div class="col-lg-4">
                <!-- Allocation Summary -->
                <div class="card shadow-sm mb-4 border-primary" id="allocationSummary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Invoice Allocation</h5>
                    </div>
                    <div class="card-body">
                        <div id="allocationStatus" class="text-center py-2">
                            <div id="noAllocationWarning" class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please select a supplier or customer below
                            </div>
                            <div id="supplierAllocated" class="alert alert-success mb-0 d-none">
                                <i class="bi bi-building me-2"></i>
                                <span>Allocated to Supplier: </span>
                                <strong id="allocatedSupplierName"></strong>
                            </div>
                            <div id="customerAllocated" class="alert alert-info mb-0 d-none">
                                <i class="bi bi-person me-2"></i>
                                <span>Allocated to Customer: </span>
                                <strong id="allocatedCustomerName"></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supplier Matching -->
                <div class="card shadow-sm mb-4 @(Model.MatchedSupplierId.HasValue ? "border-success" : "border-warning")"
                    id="supplierCard">
                    <div
                        class="card-header @(Model.MatchedSupplierId.HasValue ? "bg-success text-white" : "bg-warning")">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>Supplier Matching
                            @if (Model.MatchedSupplierId.HasValue)
                            {
                                <span class="badge bg-light text-success float-end">Matched</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-warning float-end">Not Found</span>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.ExtractedSupplierName))
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted small">Extracted from Document:</label>
                                <div class="p-2 bg-light rounded">
                                    <strong>@Model.ExtractedSupplierName</strong>
                                </div>
                            </div>
                        }

                        @if (Model.MatchedSupplierId.HasValue)
                        {
                            <div class="alert alert-success mb-3">
                                <i class="bi bi-check-circle me-2"></i>
                                Matched to: <strong>@Model.MatchedSupplierName</strong>
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="SelectedSupplierId" class="form-label">Select Supplier</label>
                            <select asp-for="SelectedSupplierId" class="form-select">
                                <option value="">-- Select Supplier --</option>
                                @if (Model.AvailableSuppliers != null)
                                {
                                    @foreach (var supplier in Model.AvailableSuppliers)
                                    {
                                        <option value="@supplier.Id" selected="@(supplier.Id == Model.MatchedSupplierId)">
                                            @supplier.SupplierName (@supplier.SupplierCode)
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        @if (!Model.MatchedSupplierId.HasValue && !string.IsNullOrEmpty(Model.ExtractedSupplierName))
                        {
                            <div class="form-check">
                                <input asp-for="CreateNewSupplier" class="form-check-input" type="checkbox" />
                                <label asp-for="CreateNewSupplier" class="form-check-label">
                                    Create new supplier from extracted name
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Customer Matching -->
                <div class="card shadow-sm mb-4 @(Model.MatchedCustomerId.HasValue ? "border-success" : "border-warning")"
                    id="customerCard">
                    <div
                        class="card-header @(Model.MatchedCustomerId.HasValue ? "bg-success text-white" : "bg-warning")">
                        <h5 class="mb-0">
                            <i class="bi bi-person-circle me-2"></i>Customer Matching
                            @if (Model.MatchedCustomerId.HasValue)
                            {
                                <span class="badge bg-light text-success float-end">Matched</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-warning float-end">Not Found</span>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.ExtractedCustomerName))
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted small">Extracted from Document:</label>
                                <div class="p-2 bg-light rounded">
                                    <strong>@Model.ExtractedCustomerName</strong>
                                </div>
                            </div>
                        }

                        @if (Model.MatchedCustomerId.HasValue)
                        {
                            <div class="alert alert-success mb-3">
                                <i class="bi bi-check-circle me-2"></i>
                                Matched to: <strong>@Model.MatchedCustomerName</strong>
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="SelectedCustomerId" class="form-label">Select Customer</label>
                            <select asp-for="SelectedCustomerId" class="form-select">
                                <option value="">-- Select Customer --</option>
                                @if (Model.AvailableCustomers != null)
                                {
                                    @foreach (var customer in Model.AvailableCustomers)
                                    {
                                        <option value="@customer.Id" selected="@(customer.Id == Model.MatchedCustomerId)">
                                            @customer.CustomerName (@customer.CustomerCode)
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        @if (!Model.MatchedCustomerId.HasValue && !string.IsNullOrEmpty(Model.ExtractedCustomerName))
                        {
                            <div class="form-check">
                                <input asp-for="CreateNewCustomer" class="form-check-input" type="checkbox" />
                                <label asp-for="CreateNewCustomer" class="form-check-label">
                                    Create new customer from extracted name
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="bi bi-check-circle me-2"></i>Save Invoice
                        </button>
                        <a asp-action="Invoice" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const supplierSelect = document.getElementById('SelectedSupplierId');
            const customerSelect = document.getElementById('SelectedCustomerId');
            const invoiceTypeInput = document.getElementById('InvoiceType');
            const supplierCard = document.getElementById('supplierCard');
            const customerCard = document.getElementById('customerCard');
            const customerInfoSection = document.getElementById('customerInfoSection');
            const customerInfoHeader = document.getElementById('customerInfoHeader');

            // Allocation type radio buttons
            const allocateSupplierRadio = document.getElementById('allocateSupplier');
            const allocateCustomerRadio = document.getElementById('allocateCustomer');

            // Allocation status elements
            const noAllocationWarning = document.getElementById('noAllocationWarning');
            const supplierAllocated = document.getElementById('supplierAllocated');
            const customerAllocated = document.getElementById('customerAllocated');
            const allocatedSupplierName = document.getElementById('allocatedSupplierName');
            const allocatedCustomerName = document.getElementById('allocatedCustomerName');

            // Function to update allocation status display
            function updateAllocationStatus() {
                const hasSupplier = supplierSelect && supplierSelect.value;
                const hasCustomer = customerSelect && customerSelect.value;

                // Hide all status indicators first
                noAllocationWarning?.classList.add('d-none');
                supplierAllocated?.classList.add('d-none');
                customerAllocated?.classList.add('d-none');

                if (hasSupplier) {
                    const selectedOption = supplierSelect.options[supplierSelect.selectedIndex];
                    const supplierName = selectedOption.text.split(' (')[0];
                    allocatedSupplierName.textContent = supplierName;
                    supplierAllocated?.classList.remove('d-none');
                } else if (hasCustomer) {
                    const selectedOption = customerSelect.options[customerSelect.selectedIndex];
                    const customerName = selectedOption.text.split(' (')[0];
                    allocatedCustomerName.textContent = customerName;
                    customerAllocated?.classList.remove('d-none');
                } else {
                    noAllocationWarning?.classList.remove('d-none');
                }
            }

            // Function to update UI based on allocation type
            function updateAllocationTypeUI() {
                const isSupplierAllocation = allocateSupplierRadio?.checked;

                // Update hidden invoice type field
                if (invoiceTypeInput) {
                    invoiceTypeInput.value = isSupplierAllocation ? 'Payable' : 'Receivable';
                }

                // Update header text and icon
                if (customerInfoHeader) {
                    customerInfoHeader.innerHTML = isSupplierAllocation
                        ? '<h5 class=\"mb-0\"><i class=\"bi bi-building me-2\"></i>Supplier/Vendor Information</h5>'
                        : '<h5 class=\"mb-0\"><i class=\"bi bi-person me-2\"></i>Customer/Client Information</h5>';
                }

                // Update the entity name label
                const entityNameLabel = document.getElementById('entityNameLabel');
                if (entityNameLabel) {
                    entityNameLabel.textContent = isSupplierAllocation ? 'Supplier Name' : 'Customer Name';
                }

                // Show/hide and highlight the relevant cards
                if (isSupplierAllocation) {
                    supplierCard?.classList.remove('d-none');
                    supplierCard?.classList.add('border-primary', 'border-2');
                    customerCard?.classList.add('d-none');
                    // Clear customer selection when switching to supplier
                    if (customerSelect) customerSelect.value = '';
                } else {
                    customerCard?.classList.remove('d-none');
                    customerCard?.classList.add('border-success', 'border-2');
                    supplierCard?.classList.add('d-none');
                    // Clear supplier selection when switching to customer
                    if (supplierSelect) supplierSelect.value = '';
                }

                updateAllocationStatus();
            }

            // When allocation type changes
            allocateSupplierRadio?.addEventListener('change', function () {
                updateAllocationTypeUI();
                showToast('Switched to Supplier allocation (Payable/Expense invoice)', 'info');
            });

            allocateCustomerRadio?.addEventListener('change', function () {
                updateAllocationTypeUI();
                showToast('Switched to Customer allocation (Receivable/Income invoice)', 'info');
            });

            // When supplier is selected
            supplierSelect?.addEventListener('change', async function () {
                if (this.value) {
                    // Get supplier name from selected option
                    const selectedOption = this.options[this.selectedIndex];
                    const supplierName = selectedOption.text.split(' (')[0];

                    // Fetch supplier details from API
                    try {
                        const response = await fetch('/AiImport/GetSupplierDetails?id=' + this.value);
                        if (response.ok) {
                            const supplier = await response.json();
                            
                            // Update the Supplier/Vendor Information fields
                            const customerNameField = document.getElementById('CustomerName');
                            const customerEmailField = document.getElementById('CustomerEmail');
                            const customerPhoneField = document.getElementById('CustomerPhone');
                            const customerAddressField = document.getElementById('CustomerAddress');
                            
                            if (customerNameField) customerNameField.value = supplier.name || '';
                            if (customerEmailField) customerEmailField.value = supplier.email || '';
                            if (customerPhoneField) customerPhoneField.value = supplier.phone || '';
                            if (customerAddressField) customerAddressField.value = supplier.address || '';
                        }
                    } catch (error) {
                        console.error('Error fetching supplier details:', error);
                    }

                    // Update allocation status
                    updateAllocationStatus();

                    // Show visual feedback
                    showToast('Supplier selected: ' + supplierName, 'success');
                } else {
                    updateAllocationStatus();
                }
            });

            // When customer is selected
            customerSelect?.addEventListener('change', async function () {
                if (this.value) {
                    // Get customer name from selected option
                    const selectedOption = this.options[this.selectedIndex];
                    const customerName = selectedOption.text.split(' (')[0];

                    // Fetch customer details from API
                    try {
                        const response = await fetch('/AiImport/GetCustomerDetails?id=' + this.value);
                        if (response.ok) {
                            const customer = await response.json();
                            
                            // Update the Customer/Client Information fields
                            const customerNameField = document.getElementById('CustomerName');
                            const customerEmailField = document.getElementById('CustomerEmail');
                            const customerPhoneField = document.getElementById('CustomerPhone');
                            const customerAddressField = document.getElementById('CustomerAddress');
                            
                            if (customerNameField) customerNameField.value = customer.name || '';
                            if (customerEmailField) customerEmailField.value = customer.email || '';
                            if (customerPhoneField) customerPhoneField.value = customer.phone || '';
                            if (customerAddressField) customerAddressField.value = customer.address || '';
                        }
                    } catch (error) {
                        console.error('Error fetching customer details:', error);
                    }

                    // Update allocation status
                    updateAllocationStatus();

                    // Show visual feedback
                    showToast('Customer selected: ' + customerName, 'success');
                } else {
                    updateAllocationStatus();
                }
            });

            // Toast notification function
            function showToast(message, type = 'info') {
                // Remove existing toast
                const existingToast = document.querySelector('.auto-toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = `auto-toast alert alert-${type === 'success' ? 'success' : 'info'} position-fixed shadow-lg`;
                toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px; animation: slideIn 0.3s ease;';
                toast.innerHTML = `
                            <div class="d-flex align-items-center">
                                <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'info-circle-fill'} me-2"></i>
                                <span>${message}</span>
                            </div>
                        `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Calculate item totals on input change
            document.querySelectorAll('.item-qty, .item-price').forEach(function (input) {
                input.addEventListener('input', function () {
                    var row = this.closest('tr');
                    var qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    var price = parseFloat(row.querySelector('.item-price').value) || 0;
                    row.querySelector('.item-total').textContent = (qty * price).toFixed(2);

                    // Recalculate subtotal
                    var subtotal = 0;
                    document.querySelectorAll('.item-total').forEach(function (cell) {
                        subtotal += parseFloat(cell.textContent) || 0;
                    });
                    document.getElementById('SubTotal').value = subtotal.toFixed(2);
                });
            });

            // Initialize UI state based on current invoice type and matched entities
            async function initializeUI() {
                const currentInvoiceType = invoiceTypeInput?.value || 'Payable';
                const hasMatchedSupplier = supplierSelect?.value || '@Model.MatchedSupplierId' !== '';
                const hasMatchedCustomer = customerSelect?.value || '@Model.MatchedCustomerId' !== '';

                // Set initial allocation type based on invoice type or matched entity
                if (currentInvoiceType === 'Receivable' || (hasMatchedCustomer && !hasMatchedSupplier)) {
                    allocateCustomerRadio.checked = true;
                } else {
                    allocateSupplierRadio.checked = true;
                }

                // Pre-select matched entities
                if ('@Model.MatchedSupplierId' && supplierSelect) {
                    supplierSelect.value = '@Model.MatchedSupplierId';
                    
                    // Fetch and populate supplier details on initial load
                    try {
                        const response = await fetch('/AiImport/GetSupplierDetails?id=@Model.MatchedSupplierId');
                        if (response.ok) {
                            const supplier = await response.json();
                            const customerNameField = document.getElementById('CustomerName');
                            const customerEmailField = document.getElementById('CustomerEmail');
                            const customerPhoneField = document.getElementById('CustomerPhone');
                            const customerAddressField = document.getElementById('CustomerAddress');
                            
                            // Only populate if fields are empty or contain extracted data
                            if (customerNameField && !customerNameField.value) customerNameField.value = supplier.name || '';
                            if (customerEmailField && !customerEmailField.value) customerEmailField.value = supplier.email || '';
                            if (customerPhoneField && !customerPhoneField.value) customerPhoneField.value = supplier.phone || '';
                            if (customerAddressField && !customerAddressField.value) customerAddressField.value = supplier.address || '';
                        }
                    } catch (error) {
                        console.error('Error fetching matched supplier details:', error);
                    }
                }
                if ('@Model.MatchedCustomerId' && customerSelect) {
                    customerSelect.value = '@Model.MatchedCustomerId';
                    
                    // Fetch and populate customer details on initial load  
                    try {
                        const response = await fetch('/AiImport/GetCustomerDetails?id=@Model.MatchedCustomerId');
                        if (response.ok) {
                            const customer = await response.json();
                            const customerNameField = document.getElementById('CustomerName');
                            const customerEmailField = document.getElementById('CustomerEmail');
                            const customerPhoneField = document.getElementById('CustomerPhone');
                            const customerAddressField = document.getElementById('CustomerAddress');
                            
                            // Only populate if fields are empty or contain extracted data
                            if (customerNameField && !customerNameField.value) customerNameField.value = customer.name || '';
                            if (customerEmailField && !customerEmailField.value) customerEmailField.value = customer.email || '';
                            if (customerPhoneField && !customerPhoneField.value) customerPhoneField.value = customer.phone || '';
                            if (customerAddressField && !customerAddressField.value) customerAddressField.value = customer.address || '';
                        }
                    } catch (error) {
                        console.error('Error fetching matched customer details:', error);
                    }
                }

                updateAllocationTypeUI();
            }

            initializeUI();
        });
    </script>

    <style>
        @@keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @@keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .border-2 {
            border-width: 2px !important;
        }

        #supplierCard.border-primary .card-header,
        #customerCard.border-primary .card-header {
            background-color: #0d6efd !important;
            color: white !important;
        }
    </style>
}