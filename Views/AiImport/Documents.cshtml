@model IEnumerable<InvoiceManagement.Models.ImportedDocument>
@{
    ViewData["Title"] = "Imported Documents";

    // Currency formatting - uses K (Kina) as default
    string FormatCurrency(decimal amount)
    {
        return $"K {amount:N2}";
    }
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-folder2-open text-primary me-2"></i>Imported Documents
            </h2>
            <p class="text-muted mb-0">
                View and manage all documents imported via AI Import.
            </p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-primary">
                <i class="bi bi-robot me-1"></i>AI Import
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-0">Total Documents</h6>
                            <h2 class="mb-0">@Model.Count()</h2>
                        </div>
                        <i class="bi bi-files fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-0">Invoices</h6>
                            <h2 class="mb-0">@Model.Count(d => d.DocumentType == "Invoice")</h2>
                        </div>
                        <i class="bi bi-receipt fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-0">Payments</h6>
                            <h2 class="mb-0">@Model.Count(d => d.DocumentType == "Payment")</h2>
                        </div>
                        <i class="bi bi-credit-card fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-0">Unlinked</h6>
                            <h2 class="mb-0">@Model.Count(d => !d.InvoiceId.HasValue && !d.PaymentId.HasValue)</h2>
                        </div>
                        <i class="bi bi-unlink fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Document List (Grouped by Type &amp; Supplier)
                    </h5>
                </div>
                <div class="col-auto d-flex gap-2">
                    <!-- Bulk Action Buttons -->
                    <div id="bulkActions" class="d-none">
                        <button type="button" class="btn btn-success btn-sm" onclick="showBulkLinkModal()"
                            title="Link selected documents to invoice">
                            <i class="bi bi-link-45deg me-1"></i>Bulk Link <span id="selectedCount"
                                class="badge bg-light text-success">0</span>
                        </button>
                    </div>
                    <!-- AI Process All Button -->
                    @{
                        var unprocessedCount = Model.Count(d => d.DocumentType == "Invoice" &&
                        d.InvoiceId == null &&
                        (string.IsNullOrEmpty(d.ProcessingNotes) ||
                        string.IsNullOrEmpty(d.ExtractedSupplierName) ||
                        d.ExtractedSupplierName == "Unknown"));
                    }
                    @if (unprocessedCount > 0)
                    {
                        <button type="button" class="btn btn-primary btn-sm" id="btnAiProcessAll" onclick="aiProcessAll()">
                            <i class="bi bi-robot me-1"></i>AI Process All <span
                                class="badge bg-light text-primary">@unprocessedCount</span>
                        </button>
                    }
                    <!-- Type Filter -->
                    <select id="typeFilter" class="form-select form-select-sm" style="width: 140px;">
                        <option value="">All Types</option>
                        <option value="invoice">Invoices</option>
                        <option value="payment">Payments</option>
                    </select>
                    <!-- Supplier Filter -->
                    <select id="supplierFilter" class="form-select form-select-sm" style="width: 180px;">
                        <option value="">All Suppliers</option>
                        @{
                            var suppliers = Model
                            .Select(d => string.IsNullOrEmpty(d.ExtractedSupplierName) &&
                            string.IsNullOrEmpty(d.ExtractedCustomerName)
                            ? "Unknown Supplier"
                                    : (d.ExtractedSupplierName ?? d.ExtractedCustomerName ?? "Unknown Supplier"))
                            .Distinct()
                            .OrderBy(s => s == "Unknown Supplier" ? "ZZZZZ" : s);
                            foreach (var supplier in suppliers)
                            {
                                <option value="@supplier.ToLower()">@supplier</option>
                            }
                        }
                    </select>
                    <!-- Search -->
                    <input type="text" id="searchInput" class="form-control form-control-sm"
                        placeholder="Search documents..." style="width: 200px;">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">No documents have been imported yet.</p>
                    <a asp-action="Index" class="btn btn-primary">
                        <i class="bi bi-robot me-1"></i>Start AI Import
                    </a>
                </div>
            }
            else
            {
                // Group documents first by Type, then by Supplier
                var typeGroups = Model
                .GroupBy(d => d.DocumentType ?? "Unknown")
                .OrderBy(g => g.Key == "Invoice" ? 0 : g.Key == "Payment" ? 1 : 2);

                var typeIndex = 0;
                <div class="accordion" id="typeAccordion">
                    @foreach (var typeGroup in typeGroups)
                    {
                        var typeId = $"type_{typeIndex}";
                        var typeIcon = typeGroup.Key == "Invoice" ? "bi-receipt text-info" :
                        typeGroup.Key == "Payment" ? "bi-credit-card text-success" : "bi-file-earmark text-secondary";
                        var typeBadgeClass = typeGroup.Key == "Invoice" ? "bg-info" :
                        typeGroup.Key == "Payment" ? "bg-success" : "bg-secondary";

                        // Group by supplier within this type
                        var supplierGroups = typeGroup
                        .GroupBy(d => string.IsNullOrEmpty(d.ExtractedSupplierName) &&
                        string.IsNullOrEmpty(d.ExtractedCustomerName)
                        ? "Unknown Supplier"
                                        : (d.ExtractedSupplierName ?? d.ExtractedCustomerName ?? "Unknown Supplier"))
                        .OrderBy(g => g.Key == "Unknown Supplier" ? "ZZZZZ" : g.Key);

                        <div class="accordion-item type-group" data-type="@typeGroup.Key.ToLower()">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(typeIndex > 0 ? "collapsed" : "")" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#@typeId">
                                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                        <span>
                                            <i class="bi @typeIcon fs-5 me-2"></i>
                                            <strong>@typeGroup.Key Documents</strong>
                                        </span>
                                        <span>
                                            <span class="badge @typeBadgeClass">@typeGroup.Count() documents</span>
                                            <span class="badge bg-secondary ms-1">@supplierGroups.Count() suppliers</span>
                                        </span>
                                    </div>
                                </button>
                            </h2>
                            <div id="@typeId" class="accordion-collapse collapse @(typeIndex == 0 ? "show" : "")"
                                data-bs-parent="#typeAccordion">
                                <div class="accordion-body p-2">
                                    <!-- Nested accordion for suppliers within this type -->
                                    <div class="accordion" id="supplierAccordion_@typeIndex">
                                        @{
                                            var supplierIndex = 0;
                                        }
                                        @foreach (var supplierGroup in supplierGroups)
                                        {
                                            var supplierId = $"supplier_{typeIndex}_{supplierIndex}";
                                            <div class="accordion-item supplier-group border"
                                                data-supplier="@supplierGroup.Key.ToLower()" data-type="@typeGroup.Key.ToLower()">
                                                <h2 class="accordion-header d-flex align-items-center">
                                                    <button class="accordion-button py-2 @(supplierIndex > 0 ? "collapsed" : "")"
                                                        type="button" data-bs-toggle="collapse" data-bs-target="#@supplierId">
                                                        <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                                            <span>
                                                                <i class="bi bi-building me-2 text-primary"></i>
                                                                <strong class="supplier-name-display">@supplierGroup.Key</strong>
                                                            </span>
                                                            <span class="badge bg-secondary">@supplierGroup.Count() docs</span>
                                                        </div>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2"
                                                        title="Edit Supplier Name"
                                                        onclick="event.stopPropagation(); editSupplier('@string.Join(",", supplierGroup.Select(d => d.Id))', '@supplierGroup.Key.Replace("'", "\\'")');">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </h2>
                                                <div id="@supplierId"
                                                    class="accordion-collapse collapse @(supplierIndex == 0 ? "show" : "")"
                                                    data-bs-parent="#supplierAccordion_@typeIndex">
                                                    <div class="accordion-body p-0">
                                                        <div class="table-responsive">
                                                            <table class="table table-hover table-sm mb-0 documentsTable">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th style="width: 40px;">
                                                                            <input type="checkbox"
                                                                                class="form-check-input select-all-supplier"
                                                                                data-supplier-id="@supplierId"
                                                                                title="Select all in this group">
                                                                        </th>
                                                                        <th>File Name</th>
                                                                        <th>Supplier/Customer</th>
                                                                        <th>Invoice #</th>
                                                                        <th>Date</th>
                                                                        <th class="text-end">Amount</th>
                                                                        <th>Size</th>
                                                                        <th>Status</th>
                                                                        <th>Linked To</th>
                                                                        <th class="text-center" style="width: 150px;">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @foreach (var doc in supplierGroup.OrderByDescending(d =>
                                                                                                                            d.UploadDate))
                                                                    {
                                                                        @* Parse ProcessingNotes JSON for invoice details *@
                                                                                        string invoiceNumber = "";
                                                                        DateTime? invoiceDate = null;
                                                                        decimal totalAmount = 0;
                                                                        string supplierCustomerName = doc.ExtractedSupplierName ??
                                                                        doc.ExtractedCustomerName ?? "";

                                                                        if (!string.IsNullOrEmpty(doc.ProcessingNotes))
                                                                        {
                                                                            try
                                                                            {
                                                                                var json =
                                                                                System.Text.Json.JsonDocument.Parse(doc.ProcessingNotes);
                                                                                if (json.RootElement.TryGetProperty("InvoiceNumber", out var
                                                                                invNum))
                                                                                    invoiceNumber = invNum.GetString() ?? "";
                                                                                if (json.RootElement.TryGetProperty("InvoiceDate", out var
                                                                                invDate) && invDate.ValueKind !=
                                                                                System.Text.Json.JsonValueKind.Null)
                                                                                    invoiceDate = invDate.GetDateTime();
                                                                                if (json.RootElement.TryGetProperty("TotalAmount", out var amt))
                                                                                    totalAmount = amt.GetDecimal();
                                                                                // Also try to get supplier name from JSON if not in field
                                                                                if (string.IsNullOrEmpty(supplierCustomerName))
                                                                                {
                                                                                    if (json.RootElement.TryGetProperty("ExtractedSupplierName", out
                                                                                    var supName))
                                                                                        supplierCustomerName = supName.GetString() ?? "";
                                                                                    if (string.IsNullOrEmpty(supplierCustomerName) &&
                                                                                    json.RootElement.TryGetProperty("CustomerName", out var
                                                                                    custName))
                                                                                        supplierCustomerName = custName.GetString() ?? "";
                                                                                }
                                                                            }
                                                                            catch { }
                                                                        }

                                                                        <tr class="document-row"
                                                                            data-filename="@doc.OriginalFileName.ToLower()"
                                                                            data-supplier="@supplierGroup.Key.ToLower()"
                                                                            data-type="@(doc.DocumentType?.ToLower() ?? "unknown")"
                                                                            data-doc-id="@doc.Id" data-invoice-number="@invoiceNumber"
                                                                            data-amount="@totalAmount">
                                                                            <td>
                                                                                @if (!doc.InvoiceId.HasValue && !doc.PaymentId.HasValue)
                                                                                {
                                                                                    <input type="checkbox"
                                                                                        class="form-check-input doc-checkbox"
                                                                                        value="@doc.Id" data-supplier-id="@supplierId"
                                                                                        onchange="updateBulkSelection()">
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                <div class="d-flex align-items-center">
                                                                                    @{
                                                                                        var iconClass = doc.ContentType?.Contains("pdf") ==
                                                                                        true ?
                                                                                        "bi-file-pdf text-danger" :
                                                                                        doc.ContentType?.Contains("image") == true ?
                                                                                        "bi-file-image text-info" :
                                                                                        "bi-file-earmark text-secondary";
                                                                                    }
                                                                                    <i class="bi @iconClass fs-6 me-2"></i>
                                                                                    <div>
                                                                                        <strong
                                                                                            class="small">@doc.OriginalFileName</strong>
                                                                                    </div>
                                                                                </div>
                                                                            </td>
                                                                            <td>
                                                                                @if (!string.IsNullOrEmpty(supplierCustomerName))
                                                                                {
                                                                                    <small
                                                                                        class="text-primary fw-bold">@supplierCustomerName</small>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="text-muted fst-italic small">Unknown</span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @if (!string.IsNullOrEmpty(invoiceNumber))
                                                                                {
                                                                                    <code class="small">@invoiceNumber</code>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="text-muted">-</span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @if (invoiceDate.HasValue)
                                                                                {
                                                                                    <small>@invoiceDate.Value.ToString("dd/MM/yyyy")</small>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="text-muted">-</span>
                                                                                }
                                                                            </td>
                                                                            <td class="text-end">
                                                                                @if (totalAmount > 0)
                                                                                {
                                                                                    <strong
                                                                                        class="small text-success">@FormatCurrency(totalAmount)</strong>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="text-muted">-</span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @{
                                                                                    var sizeKB = doc.FileSize / 1024.0;
                                                                                    var sizeMB = sizeKB / 1024.0;
                                                                                    var sizeDisplay = sizeMB >= 1 ? $"{sizeMB:N1} MB" :
                                                                                    $"{sizeKB:N0} KB";
                                                                                }
                                                                                <small>@sizeDisplay</small>
                                                                            </td>
                                                                            <td>
                                                                                @if (doc.ProcessingStatus == "Processed" || doc.ProcessingStatus == "Linked" || doc.ProcessingStatus == "Completed" || doc.InvoiceId.HasValue || doc.PaymentId.HasValue)
                                                                                {
                                                                                    <span class="badge bg-success">
                                                                                        <i class="bi bi-check-circle"></i>
                                                                                    </span>
                                                                                }
                                                                                else if (doc.ProcessingStatus == "Failed" || doc.ProcessingStatus == "Error")
                                                                                {
                                                                                    <span class="badge bg-danger"
                                                                                        title="@doc.ProcessingNotes">
                                                                                        <i class="bi bi-x-circle"></i>
                                                                                    </span>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="badge bg-secondary">
                                                                                        <i class="bi bi-hourglass"></i>
                                                                                    </span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @if (doc.InvoiceId.HasValue && doc.Invoice != null)
                                                                                {
                                                                                    <a asp-controller="Invoices" asp-action="Details"
                                                                                        asp-route-id="@doc.InvoiceId"
                                                                                        class="text-decoration-none small">
                                                                                        <i
                                                                                            class="bi bi-receipt me-1"></i>@doc.Invoice.InvoiceNumber
                                                                                    </a>
                                                                                }
                                                                                else if (doc.PaymentId.HasValue && doc.Payment != null)
                                                                                {
                                                                                    <a asp-controller="Payments" asp-action="Details"
                                                                                        asp-route-id="@doc.PaymentId"
                                                                                        class="text-decoration-none small">
                                                                                        <i
                                                                                            class="bi bi-credit-card me-1"></i>@doc.Payment.PaymentNumber
                                                                                    </a>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span class="text-muted small">
                                                                                        <i class="bi bi-dash"></i>
                                                                                    </span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                <small>@doc.UploadDate.ToString("dd MMM yyyy")</small>
                                                                            </td>
                                                                            <td class="text-center">
                                                                                <div class="btn-group btn-group-sm">
                                                                                    @if (!doc.InvoiceId.HasValue &&
                                                                                                                                                        !doc.PaymentId.HasValue)
                                                                                    {
                                                                                        @if (doc.DocumentType == "Invoice")
                                                                                        {
                                                                                            <a asp-action="ReviewInvoice"
                                                                                                asp-route-documentId="@doc.Id"
                                                                                                class="btn btn-success btn-sm"
                                                                                                title="Review & Create Invoice">
                                                                                                <i class="bi bi-pencil-square"></i>
                                                                                            </a>
                                                                                        }
                                                                                        else if (doc.DocumentType == "Payment")
                                                                                        {
                                                                                            <a asp-action="ReviewPayment"
                                                                                                asp-route-documentId="@doc.Id"
                                                                                                class="btn btn-success btn-sm"
                                                                                                title="Review & Create Payment">
                                                                                                <i class="bi bi-pencil-square"></i>
                                                                                            </a>
                                                                                        }
                                                                                    }
                                                                                    <a asp-action="ViewDocument" asp-route-id="@doc.Id"
                                                                                        class="btn btn-outline-info btn-sm"
                                                                                        title="Preview">
                                                                                        <i class="bi bi-eye"></i>
                                                                                    </a>
                                                                                    <a asp-action="DownloadDocument"
                                                                                        asp-route-id="@doc.Id"
                                                                                        class="btn btn-outline-primary btn-sm"
                                                                                        title="Download">
                                                                                        <i class="bi bi-download"></i>
                                                                                    </a>
                                                                                    <button type="button"
                                                                                        class="btn btn-outline-danger btn-sm"
                                                                                        title="Delete"
                                                                                        onclick="confirmDelete(@doc.Id, '@doc.OriginalFileName')">
                                                                                        <i class="bi bi-trash"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            supplierIndex++;
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        typeIndex++;
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteFileName"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Supplier Name Modal -->
<div class="modal fade" id="editSupplierModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square text-primary me-2"></i>Edit Supplier Name
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editSupplierForm" method="post" asp-action="UpdateDocumentSupplier">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <p class="text-muted small mb-3">Update the supplier name for all documents in this group.</p>
                    <input type="hidden" id="editDocumentIds" name="documentIds" />
                    <div class="mb-3">
                        <label class="form-label">Current Supplier Name</label>
                        <input type="text" id="currentSupplierName" class="form-control" readonly disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Existing Supplier</label>
                        <select id="supplierDropdown" class="form-select">
                            <option value="">-- Select a supplier or type below --</option>
                            @if (ViewBag.Suppliers != null)
                            {
                                foreach (var supplier in ViewBag.Suppliers)
                                {
                                    <option value="@supplier.SupplierName">@supplier.SupplierName</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Enter New Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" id="newSupplierName" name="supplierName" class="form-control" required
                            placeholder="Enter new supplier name" />
                        <div class="form-text">Select from dropdown above or type a new name here.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Link Modal -->
<div class="modal fade" id="bulkLinkModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-link-45deg me-2"></i>Bulk Link Documents to Invoice
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong id="bulkLinkCount">0</strong> document(s) selected for linking.
                </div>

                <div id="selectedDocsList" class="mb-3 small" style="max-height: 200px; overflow-y: auto;">
                    <!-- Selected documents will be listed here -->
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Select Invoice to Link</label>
                    <select id="bulkLinkInvoiceSelect" class="form-select">
                        <option value="">-- Select an invoice --</option>
                    </select>
                    <div class="form-text">Search by invoice number or supplier name</div>
                </div>

                <div id="invoicePreview" class="d-none border rounded p-3 bg-light">
                    <h6 class="mb-2"><i class="bi bi-receipt me-1"></i>Invoice Details</h6>
                    <div class="row small">
                        <div class="col-md-6"><strong>Invoice #:</strong> <span id="previewInvoiceNumber"></span></div>
                        <div class="col-md-6"><strong>Date:</strong> <span id="previewInvoiceDate"></span></div>
                        <div class="col-md-6"><strong>Supplier:</strong> <span id="previewSupplier"></span></div>
                        <div class="col-md-6"><strong>Amount:</strong> <span id="previewAmount"></span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="btnConfirmBulkLink" onclick="confirmBulkLink()"
                    disabled>
                    <i class="bi bi-link-45deg me-1"></i>Link Documents
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Processing Progress Modal -->
<div class="modal fade" id="aiProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-robot me-2"></i>AI Processing Documents
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <h5 id="aiProgressText">Processing documents...</h5>
                <p class="text-muted" id="aiProgressDetails">Please wait while AI extracts information from all
                    documents.</p>
                <div class="progress mt-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        id="aiProgressBar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Combined filter function
        function applyFilters() {
            var searchFilter = document.getElementById('searchInput').value.toLowerCase();
            var typeFilter = document.getElementById('typeFilter').value.toLowerCase();
            var supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();

            // Process type groups (outer level)
            var typeGroups = document.querySelectorAll('.type-group');

            typeGroups.forEach(function (typeGroup) {
                var groupType = typeGroup.getAttribute('data-type');

                // Check if this type group matches the type filter
                var typeMatches = !typeFilter || groupType === typeFilter;

                if (!typeMatches) {
                    // Hide entire type group if type doesn't match
                    typeGroup.style.display = 'none';
                    return;
                }

                // Process supplier groups (inner level) within this type
                var supplierGroups = typeGroup.querySelectorAll('.supplier-group');
                var visibleSupplierGroups = 0;

                supplierGroups.forEach(function (supplierGroup) {
                    var groupSupplier = supplierGroup.getAttribute('data-supplier');
                    var rows = supplierGroup.querySelectorAll('.document-row');
                    var visibleRows = 0;

                    // Check if this supplier group matches the supplier filter
                    var supplierMatches = !supplierFilter || groupSupplier === supplierFilter;

                    if (!supplierMatches) {
                        // Hide entire supplier group if supplier doesn't match
                        supplierGroup.style.display = 'none';
                        return;
                    }

                    rows.forEach(function (row) {
                        var text = row.textContent.toLowerCase();

                        // Check search filter
                        var searchMatches = !searchFilter || text.includes(searchFilter) || groupSupplier.includes(searchFilter);

                        var visible = searchMatches;
                        row.style.display = visible ? '' : 'none';
                        if (visible) visibleRows++;
                    });

                    // Show/hide supplier group based on matches
                    supplierGroup.style.display = visibleRows > 0 ? '' : 'none';
                    if (visibleRows > 0) visibleSupplierGroups++;

                    // Auto-expand supplier groups with matches when filtering
                    if ((searchFilter || supplierFilter) && visibleRows > 0) {
                        var collapse = supplierGroup.querySelector('.accordion-collapse');
                        if (collapse && !collapse.classList.contains('show')) {
                            collapse.classList.add('show');
                            var button = supplierGroup.querySelector('.accordion-button');
                            if (button) button.classList.remove('collapsed');
                        }
                    }
                });

                // Show/hide type group based on visible supplier groups
                typeGroup.style.display = visibleSupplierGroups > 0 ? '' : 'none';

                // Auto-expand type groups with matches when filtering
                if ((searchFilter || typeFilter || supplierFilter) && visibleSupplierGroups > 0) {
                    var collapse = typeGroup.querySelector(':scope > .accordion-item > .accordion-collapse');
                    if (collapse && !collapse.classList.contains('show')) {
                        collapse.classList.add('show');
                        var button = typeGroup.querySelector(':scope > .accordion-item > .accordion-header .accordion-button');
                        if (button) button.classList.remove('collapsed');
                    }
                }
            });

            // Update visible count display
            updateVisibleCount();
        }

        function updateVisibleCount() {
            var hiddenByFilter = document.querySelectorAll('.document-row[style*="display: none"]');
            var total = document.querySelectorAll('.document-row').length;
            var visible = total - hiddenByFilter.length;
            // Could add a counter display if desired
        }

        // Event listeners for all filters
        document.getElementById('searchInput').addEventListener('keyup', applyFilters);
        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('supplierFilter').addEventListener('change', applyFilters);

        // Delete confirmation
        function confirmDelete(id, fileName) {
            document.getElementById('deleteFileName').textContent = fileName;
            document.getElementById('deleteForm').action = '@Url.Action("DeleteDocument")/' + id;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Edit supplier name
        function editSupplier(documentIds, currentName) {
            document.getElementById('editDocumentIds').value = documentIds;
            document.getElementById('currentSupplierName').value = currentName;
            document.getElementById('supplierDropdown').value = '';
            document.getElementById('newSupplierName').value = currentName === 'Unknown Supplier' ? '' : currentName;
            new bootstrap.Modal(document.getElementById('editSupplierModal')).show();
        }

        // When supplier dropdown changes, update the text field
        document.getElementById('supplierDropdown').addEventListener('change', function () {
            if (this.value) {
                document.getElementById('newSupplierName').value = this.value;
            }
        });

        // ==================== BULK SELECTION ====================

        // Update bulk selection count and visibility
        function updateBulkSelection() {
            var checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            var count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;

            var bulkActions = document.getElementById('bulkActions');
            if (count > 0) {
                bulkActions.classList.remove('d-none');
            } else {
                bulkActions.classList.add('d-none');
            }
        }

        // Select all in supplier group
        document.querySelectorAll('.select-all-supplier').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                var supplierId = this.getAttribute('data-supplier-id');
                var checkboxes = document.querySelectorAll('.doc-checkbox[data-supplier-id="' + supplierId + '"]');
                checkboxes.forEach(function (cb) {
                    cb.checked = checkbox.checked;
                });
                updateBulkSelection();
            });
        });

        // ==================== BULK LINK ====================

        var invoicesCache = null;

        // Show bulk link modal
        async function showBulkLinkModal() {
            var checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            var count = checkboxes.length;

            if (count === 0) {
                alert('Please select at least one document.');
                return;
            }

            document.getElementById('bulkLinkCount').textContent = count;

            // Build list of selected documents
            var docsList = document.getElementById('selectedDocsList');
            docsList.innerHTML = '';
            checkboxes.forEach(function (cb) {
                var row = cb.closest('tr');
                var fileName = row.querySelector('td:nth-child(2) strong')?.textContent || 'Unknown';
                var invoiceNum = row.getAttribute('data-invoice-number') || '-';
                var amount = row.getAttribute('data-amount') || '0';

                var item = document.createElement('div');
                item.className = 'border-bottom py-1';
                item.innerHTML = '<i class="bi bi-file-earmark me-1"></i>' + fileName +
                    ' <span class="text-muted">(Inv: ' + invoiceNum + ', K ' + parseFloat(amount).toFixed(2) + ')</span>';
                docsList.appendChild(item);
            });

            // Load invoices if not cached
            if (!invoicesCache) {
                await loadInvoices();
            }

            document.getElementById('bulkLinkInvoiceSelect').value = '';
            document.getElementById('invoicePreview').classList.add('d-none');
            document.getElementById('btnConfirmBulkLink').disabled = true;

            new bootstrap.Modal(document.getElementById('bulkLinkModal')).show();
        }

        // Load invoices for dropdown
        async function loadInvoices() {
            try {
                const response = await fetch('/AiImport/GetInvoicesList');
                if (response.ok) {
                    invoicesCache = await response.json();
                    populateInvoiceDropdown();
                } else {
                    // Fallback - load from page data
                    console.log('API not available, using fallback');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }

        function populateInvoiceDropdown() {
            var select = document.getElementById('bulkLinkInvoiceSelect');
            select.innerHTML = '<option value="">-- Select an invoice --</option>';

            if (invoicesCache && invoicesCache.length > 0) {
                invoicesCache.forEach(function (inv) {
                    var option = document.createElement('option');
                    option.value = inv.id;
                    var partyName = inv.supplierName || inv.customerName || 'Unknown';
                    option.textContent = inv.invoiceNumber + ' - ' + partyName + ' (' + inv.currency + ' ' + inv.totalAmount.toFixed(2) + ')';
                    option.setAttribute('data-invoice', JSON.stringify(inv));
                    select.appendChild(option);
                });
            }
        }

        // Invoice selection change
        document.getElementById('bulkLinkInvoiceSelect').addEventListener('change', function () {
            var option = this.options[this.selectedIndex];
            var preview = document.getElementById('invoicePreview');

            if (this.value && option.getAttribute('data-invoice')) {
                var inv = JSON.parse(option.getAttribute('data-invoice'));
                document.getElementById('previewInvoiceNumber').textContent = inv.invoiceNumber;
                document.getElementById('previewInvoiceDate').textContent = inv.invoiceDate || 'N/A';
                document.getElementById('previewSupplier').textContent = inv.supplierName || inv.customerName || 'Unknown';
                document.getElementById('previewAmount').textContent = inv.currency + ' ' + inv.totalAmount.toFixed(2);
                preview.classList.remove('d-none');
                document.getElementById('btnConfirmBulkLink').disabled = false;
            } else {
                preview.classList.add('d-none');
                document.getElementById('btnConfirmBulkLink').disabled = true;
            }
        });

        // Confirm bulk link
        async function confirmBulkLink() {
            var invoiceId = document.getElementById('bulkLinkInvoiceSelect').value;
            if (!invoiceId) {
                alert('Please select an invoice.');
                return;
            }

            var checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            var documentIds = Array.from(checkboxes).map(cb => cb.value);

            if (documentIds.length === 0) {
                alert('No documents selected.');
                return;
            }

            document.getElementById('btnConfirmBulkLink').disabled = true;
            document.getElementById('btnConfirmBulkLink').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Linking...';

            try {
                const response = await fetch('/AiImport/BulkLinkDocuments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        documentIds: documentIds,
                        invoiceId: parseInt(invoiceId)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Successfully linked ' + result.linkedCount + ' document(s) to invoice.');
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'Failed to link documents.'));
                    document.getElementById('btnConfirmBulkLink').disabled = false;
                    document.getElementById('btnConfirmBulkLink').innerHTML = '<i class="bi bi-link-45deg me-1"></i>Link Documents';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error linking documents. Please try again.');
                document.getElementById('btnConfirmBulkLink').disabled = false;
                document.getElementById('btnConfirmBulkLink').innerHTML = '<i class="bi bi-link-45deg me-1"></i>Link Documents';
            }
        }

        // ==================== AI PROCESS ALL ====================

        async function aiProcessAll() {
            var btn = document.getElementById('btnAiProcessAll');
            var originalText = btn.innerHTML;
            btn.disabled = true;

            // Show progress modal
            var progressModal = new bootstrap.Modal(document.getElementById('aiProgressModal'));
            progressModal.show();

            document.getElementById('aiProgressBar').style.width = '10%';
            document.getElementById('aiProgressBar').textContent = '10%';
            document.getElementById('aiProgressText').textContent = 'Starting AI extraction...';

            try {
                const response = await fetch('/AiImport/ExtractAllDocumentsAjax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                document.getElementById('aiProgressBar').style.width = '90%';
                document.getElementById('aiProgressBar').textContent = '90%';

                const result = await response.json();

                document.getElementById('aiProgressBar').style.width = '100%';
                document.getElementById('aiProgressBar').textContent = '100%';
                document.getElementById('aiProgressBar').classList.remove('progress-bar-animated');

                if (result.success) {
                    document.getElementById('aiProgressText').textContent = 'Processing Complete!';
                    document.getElementById('aiProgressDetails').innerHTML =
                        '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Successfully processed ' +
                        result.processedCount + ' document(s).</span>' +
                        (result.failedCount > 0 ? '<br><span class="text-warning">' + result.failedCount + ' document(s) failed.</span>' : '');

                    setTimeout(function () {
                        progressModal.hide();
                        location.reload();
                    }, 2000);
                } else {
                    document.getElementById('aiProgressText').textContent = 'Error';
                    document.getElementById('aiProgressDetails').innerHTML =
                        '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>' + (result.message || 'Unknown error') + '</span>';
                    document.getElementById('aiProgressBar').classList.add('bg-danger');

                    setTimeout(function () {
                        progressModal.hide();
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('aiProgressText').textContent = 'Error';
                document.getElementById('aiProgressDetails').innerHTML =
                    '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Failed to process documents. Please try again.</span>';
                document.getElementById('aiProgressBar').classList.add('bg-danger');

                setTimeout(function () {
                    progressModal.hide();
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 3000);
            }
        }
    </script>
}