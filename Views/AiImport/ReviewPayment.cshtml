@model InvoiceManagement.Models.ViewModels.AiImportPaymentViewModel
@{
    ViewData["Title"] = "Review Imported Payment";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-credit-card-2-back text-success me-2"></i>Review Imported Payment
            </h2>
            <p class="text-muted mb-0">
                Verify the extracted payment data from BSP bank statement and match to supplier.
            </p>
        </div>
        <div class="d-flex gap-2">
            @if (Model.DocumentId > 0)
            {
                <a asp-action="RescanPayment" asp-route-documentId="@Model.DocumentId" class="btn btn-warning">
                    <i class="bi bi-arrow-clockwise me-1"></i>Rescan with AI
                </a>
            }
            <a asp-action="Payment" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Start Over
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.OriginalFileName))
    {
        <div class="alert alert-info d-flex align-items-center mb-4">
            <i class="bi bi-file-earmark-text fs-4 me-3"></i>
            <div>
                <strong>Source Document:</strong> @Model.OriginalFileName
                @if (Model.DocumentId > 0)
                {
                    <span class="badge bg-success ms-2">Stored</span>
                }
            </div>
        </div>
    }

    <form asp-action="SavePayment" method="post">
        <input type="hidden" asp-for="DocumentId" />
        <input type="hidden" asp-for="OriginalFileName" />
        <input type="hidden" asp-for="MatchedSupplierId" />
        <input type="hidden" asp-for="MatchedSupplierName" />
        <input type="hidden" asp-for="MatchedCustomerId" />
        <input type="hidden" asp-for="MatchedCustomerName" />
        <input type="hidden" asp-for="PaymentDirection" />
        <input type="hidden" asp-for="MatchConfidence" />
        <input type="hidden" asp-for="MatchedByField" />
        <input type="hidden" asp-for="TransferTo" />
        <input type="hidden" asp-for="AccountType" />
        <input type="hidden" asp-for="PayerAccountFull" />
        <input type="hidden" asp-for="PayerBranchNumber" />
        <input type="hidden" asp-for="PayerAccountNumber" />
        <input type="hidden" asp-for="PayeeBranchNumber" />
        <input type="hidden" asp-for="PayeeAccountNumber" />
        <input type="hidden" asp-for="Currency" />
        <input type="hidden" asp-for="RelatedInvoiceNumber" />
        <input type="hidden" asp-for="ExtractedBankName" />
        <input type="hidden" asp-for="ExtractedBankAccountNumber" />
        <input type="hidden" asp-for="ExtractedPayerName" />
        <input type="hidden" asp-for="ExtractedPayeeName" />

        <div class="row">
            <!-- Left Column: Payment Details -->
            <div class="col-lg-8">
                <!-- Payment Transaction Details -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Transaction Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ReferenceNumber" class="form-label">
                                    <i class="bi bi-hash text-primary me-1"></i>Reference Number <span
                                        class="text-danger">*</span>
                                </label>
                                <input asp-for="ReferenceNumber" class="form-control fw-bold" readonly />
                                <small class="text-muted">Bank transaction reference (unique identifier)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="PaymentDate" class="form-label">
                                    <i class="bi bi-calendar-event text-primary me-1"></i>Payment Date <span
                                        class="text-danger">*</span>
                                </label>
                                <input type="text" name="PaymentDate" id="PaymentDate" class="form-control"
                                    value="@(Model.PaymentDate?.ToString("dd/MM/yyyy"))" placeholder="dd/mm/yyyy"
                                    required />
                                <small class="text-muted">Transfer When date from statement</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Amount" class="form-label">
                                    <i class="bi bi-cash-coin text-success me-1"></i>Amount <span
                                        class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white">@Model.Currency</span>
                                    <input asp-for="Amount" type="number" step="0.01"
                                        class="form-control text-end fs-4 fw-bold text-success" required />
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="PaymentMethod" class="form-label">
                                    <i class="bi bi-credit-card text-primary me-1"></i>Payment Method
                                </label>
                                <select asp-for="PaymentMethod" class="form-select">
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Direct Debit">Direct Debit</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BSP Bank Details -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bank me-2"></i>BSP Bank Statement Details
                            @if (!string.IsNullOrEmpty(Model.AccountType))
                            {
                                <span
                                    class="badge @(Model.AccountType == "Internal" ? "bg-success" : "bg-warning text-dark") ms-2">
                                    @Model.AccountType
                                </span>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Transfer To (Supplier with Bank) -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-bold text-danger">
                                    <i class="bi bi-arrow-up-right text-danger me-1"></i>TRANSFER TO (Supplier)
                                </label>
                                <input asp-for="TransferTo" class="form-control form-control-lg bg-light" readonly />
                                <small class="text-muted">Supplier name with bank suffix (e.g., "BSP" = Bank South
                                    Pacific)</small>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Payee (Supplier) Details -->
                            <div class="col-md-6">
                                <div class="card border-danger mb-3">
                                    <div class="card-header bg-danger bg-opacity-10 text-danger">
                                        <strong><i class="bi bi-building me-1"></i>Payee (Supplier) Bank
                                            Details</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Account Name (Supplier)</label>
                                            <input asp-for="ExtractedPayeeName" class="form-control fw-bold" readonly />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Bank</label>
                                            <input asp-for="ExtractedBankName" class="form-control" readonly />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Full Account Number</label>
                                            <input asp-for="ExtractedBankAccountNumber"
                                                class="form-control font-monospace" readonly />
                                        </div>
                                        <div class="row">
                                            <div class="col-5">
                                                <label class="form-label small text-muted">Branch</label>
                                                <input asp-for="PayeeBranchNumber"
                                                    class="form-control font-monospace text-center" readonly />
                                            </div>
                                            <div class="col-7">
                                                <label class="form-label small text-muted">Account No</label>
                                                <input asp-for="PayeeAccountNumber" class="form-control font-monospace"
                                                    readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payer (Our Company) Details -->
                            <div class="col-md-6">
                                <div class="card border-success mb-3">
                                    <div class="card-header bg-success bg-opacity-10 text-success">
                                        <strong><i class="bi bi-house-door me-1"></i>Payer (Our Company) Bank
                                            Details</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Company Name</label>
                                            <input asp-for="ExtractedPayerName" class="form-control fw-bold" readonly />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Bank</label>
                                            <input value="BSP (Bank South Pacific)" class="form-control" readonly />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Full Account Number (Transfer
                                                From)</label>
                                            <input asp-for="PayerAccountFull" class="form-control font-monospace"
                                                readonly />
                                        </div>
                                        <div class="row">
                                            <div class="col-5">
                                                <label class="form-label small text-muted">Branch</label>
                                                <input asp-for="PayerBranchNumber"
                                                    class="form-control font-monospace text-center" readonly />
                                            </div>
                                            <div class="col-7">
                                                <label class="form-label small text-muted">Account No</label>
                                                <input asp-for="PayerAccountNumber" class="form-control font-monospace"
                                                    readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purpose and Notes -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Purpose & Notes</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Purpose" class="form-label">Purpose</label>
                                <input asp-for="Purpose" class="form-control" placeholder="Payment purpose/reason..." />
                                <small class="text-muted">Often empty - can be updated after saving</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Related Invoice (from Note)</label>
                                <input asp-for="RelatedInvoiceNumber" class="form-control bg-light" readonly />
                                <small class="text-muted">Invoice reference extracted from Note field</small>
                            </div>
                            <div class="col-12 mb-3">
                                <label asp-for="Notes" class="form-label">Notes</label>
                                <textarea asp-for="Notes" class="form-control" rows="3"
                                    placeholder="Additional notes from bank statement..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link to Invoice -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Link to Invoice for Reconciliation</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="SelectedInvoiceId" class="form-label">Select Invoice to Link</label>
                            <select asp-for="SelectedInvoiceId" class="form-select">
                                <option value="">-- No Invoice Link (Allocate Later) --</option>
                                @if (Model.AvailableInvoices != null)
                                {
                                    @foreach (var invoice in Model.AvailableInvoices)
                                    {
                                        var remaining = invoice.TotalAmount - invoice.PaidAmount;
                                        var isMatch = !string.IsNullOrEmpty(Model.RelatedInvoiceNumber) &&
                                        invoice.InvoiceNumber.Contains(Model.RelatedInvoiceNumber);
                                        <option value="@invoice.Id" class="@(isMatch ? "bg-success text-white" : "")">
                                            @(isMatch ? "âœ“ " : "")@invoice.InvoiceNumber - @invoice.CustomerName
                                            (@Model.Currency @invoice.TotalAmount.ToString("N2") | Remaining: @Model.Currency
                                            @remaining.ToString("N2"))
                                        </option>
                                    }
                                }
                            </select>
                            <small class="text-muted">Only showing unpaid/partially paid invoices</small>
                            @if (!string.IsNullOrEmpty(Model.RelatedInvoiceNumber))
                            {
                                <div class="alert alert-info mt-2 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Invoice reference "<strong>@Model.RelatedInvoiceNumber</strong>" found in Note field.
                                    Look for matching invoice above.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Entity Matching & Actions -->
            <div class="col-lg-4">
                <!-- Payment Direction -->
                <div class="card shadow-sm mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-up-right-circle me-2"></i>Outgoing Payment
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">
                            This is an <strong>outgoing payment</strong> from our company to a supplier.
                        </p>
                    </div>
                </div>

                <!-- Supplier Matching -->
                <div
                    class="card shadow-sm mb-4 @(Model.MatchedSupplierId.HasValue ? "border-success" : "border-warning")">
                    <div
                        class="card-header @(Model.MatchedSupplierId.HasValue ? "bg-success text-white" : "bg-warning")">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>Match to Supplier
                            @if (Model.MatchedSupplierId.HasValue)
                            {
                                <span class="badge bg-light text-success float-end">
                                    <i class="bi bi-check-circle"></i> Auto-Matched
                                </span>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.MatchedSupplierId.HasValue)
                        {
                            <div class="alert alert-success mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill fs-4 me-2"></i>
                                    <div>
                                        <strong>@Model.MatchedSupplierName</strong>
                                        @if (!string.IsNullOrEmpty(Model.MatchedByField))
                                        {
                                            <br />
                                    
                                            <small>Matched by: @Model.MatchedByField</small>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.MatchConfidence))
                                        {
                                            <br />
                                    
                                            <small>Confidence: @Model.MatchConfidence</small>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                No matching supplier found. Please select or create one.
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="SelectedSupplierId" class="form-label">Select Supplier</label>
                            <select asp-for="SelectedSupplierId" class="form-select">
                                <option value="">-- Select Supplier --</option>
                                @if (Model.AvailableSuppliers != null)
                                {
                                    @foreach (var supplier in Model.AvailableSuppliers)
                                    {
                                        var isMatched = supplier.Id == Model.MatchedSupplierId;
                                        <option value="@supplier.Id" selected="@isMatched">
                                            @supplier.SupplierName (@supplier.SupplierCode)
                                            @if (!string.IsNullOrEmpty(supplier.BankAccountNumber))
                                            {
                                                @: - @supplier.BankAccountNumber
                                            }
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        @if (!Model.MatchedSupplierId.HasValue && !string.IsNullOrEmpty(Model.ExtractedPayeeName))
                        {
                            <div class="form-check mt-3 p-3 border rounded bg-light">
                                <input asp-for="CreateNewSupplier" class="form-check-input" type="checkbox"
                                    id="createSupplierCheck" />
                                <label asp-for="CreateNewSupplier" class="form-check-label">
                                    <strong>Create new supplier:</strong><br />
                                    <span class="text-primary">@Model.ExtractedPayeeName</span>
                                </label>
                                @if (!string.IsNullOrEmpty(Model.ExtractedBankAccountNumber))
                                {
                                    <br />
                            
                                    <small class="text-muted">
                                        <i class="bi bi-bank me-1"></i>@Model.ExtractedBankName:
                                        @Model.ExtractedBankAccountNumber
                                    </small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Customer Matching (Hidden for outgoing payments but available if needed) -->
                <div class="card shadow-sm mb-4 d-none">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-person-circle me-2"></i>Customer (if incoming)</h5>
                    </div>
                    <div class="card-body">
                        <select asp-for="SelectedCustomerId" class="form-select">
                            <option value="">-- Select Customer --</option>
                            @if (Model.AvailableCustomers != null)
                            {
                                @foreach (var customer in Model.AvailableCustomers)
                                {
                                    <option value="@customer.Id">@customer.CustomerName</option>
                                }
                            }
                        </select>
                        <input type="hidden" asp-for="CreateNewCustomer" value="false" />
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="bi bi-check-circle me-2"></i>Save Payment
                        </button>
                        <a asp-action="Payment" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="card shadow-sm mt-4 bg-light">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>Payment Summary</h6>
                    </div>
                    <div class="card-body small">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td class="text-muted">Reference:</td>
                                <td class="fw-bold font-monospace">@Model.ReferenceNumber</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Amount:</td>
                                <td class="fw-bold text-success">@Model.Currency @Model.Amount.ToString("N2")</td>
                            </tr>
                            <tr>
                                <td class="text-muted">To:</td>
                                <td class="fw-bold">@Model.ExtractedPayeeName</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Bank:</td>
                                <td>@Model.ExtractedBankName</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Account:</td>
                                <td class="font-monospace">@Model.ExtractedBankAccountNumber</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Ensure supplier is selected or created
        document.querySelector('form').addEventListener('submit', function (e) {
            var supplierId = document.querySelector('[name="SelectedSupplierId"]').value;
            var createSupplier = document.getElementById('createSupplierCheck');

            if (!supplierId && (!createSupplier || !createSupplier.checked)) {
                if (!confirm('No supplier selected. Continue without linking to a supplier?')) {
                    e.preventDefault();
                }
            }
        });
    </script>
}